<div class="container">
    <div class="global">
	<div class="homelink">
        	<button (click)="backToHome()">{{datastore.Name}} </button>
		<span class="breadcrumbs-divider">►</span>    
		<button (click)="backToPostgresDatabase()">[{{postgresDatabase.Type}}] {{postgresDatabase.Name}}</button>
		<span class="breadcrumbs-divider">►</span>
		<p > {{schema.Name}}</p>
		<span class="breadcrumbs-divider">|</span>
		<p class="add" (click)="varform=1">+ Add table</p>
		<span class="breadcrumbs-divider">|</span>
		<button (click)="deleteSchema()" class="delete"> Delete schema </button>
	</div>

	<form [formGroup]="tableForm" (ngSubmit)="addPostgresTable()"  *ngIf="varform === 1">
		<input  type="text" placeholder="Name of a new table" formControlName="Name">
		<button> Add Table </button>
	</form>
<!--           Display annotations assigned to schema          -->
	<div class="annotation-list">
		<ng-container *ngFor="let ab of annotationBases; let i=index;">
			<ng-container *ngFor="let a of annotations; let i=index;">
				<ng-container *ngIf="schema.Id===ab.BaseId && ab.AnnotationId===a.Id">
					<p class="annotation"> {{a.Description}} |<button (click)="deleteAnnotationBase(ab.Id)" class="remove-annotation">Remove</button></p>
				</ng-container>
			</ng-container>
		</ng-container>

	<!--           Annotations panel           -->
		<span class="breadcrumbs-divider">|</span>
		<p class="add-annotation" (click)="varform=1.5">+ New annotation</p>
		<span class="breadcrumbs-divider">|</span>		
		<p class="add-annotation" (click)="varform=2.5"> Assign annotation to schema</p>
		<span class="breadcrumbs-divider">|</span>
		<p class="add-annotation" (click)="varform=3.5"> Manage annotations</p>
	</div>
	<!--           Form to add annotations           -->
	<form [formGroup]="annotationForm" (ngSubmit)="addAnnotation()"  *ngIf="varform === 1.5">
      		<input  type="text" placeholder="Description" formControlName="Description">
		<button [disabled]="annotationForm.pristine || annotationForm.invalid"> Add annotation </button>
	</form>
	<!--           Form to assign annotation to schema           -->
    	<form [formGroup]="annotationBaseForm" (ngSubmit)="addAnnotationBase()"  *ngIf="varform === 2.5">
		<select name="annotations" formControlName="AnnotationId">
			<ng-container *ngFor="let a of annotations; let i=index;">
			  	<option [value]="a.Id">{{a.Description}}</option>  
			</ng-container>
		</select> 
		<button [disabled]="annotationBaseForm.pristine || annotationBaseForm.invalid"> Assign annotation </button>
	</form>
	<div class="annotation-list-manage">
	<!--           Display all annotations          -->
		<ng-container  *ngIf="varform === 3.5">
			<p>List of annotations</p>
			<ng-container *ngFor="let a of annotations; let i=index;">
					<p class="annotation-manage" (click)="varform=2.5"> {{a.Description}}|<button (click)="deleteAnnotation(a.Id)" class="delete-annotation"> Delete </button></p>
			</ng-container>
		</ng-container>
	</div>
	<!--           Display tables          -->
	<div class="table-list">
		<ng-container *ngFor="let t of tables; let i=index;">
		
			<div *ngIf="t.SchemaId==schema.Id" class="table">
				<div class="table-name">[{{t.Id}}] {{t.Name}} |  <button (click)="deleteTable(t.Id)">Delete</button> |  <p class="add-annotation" (click)="varform=5.5"> Assign annotation</p></div>
			<!--           Display table annotations          -->
				<ng-container *ngFor="let ab of annotationBases; let i=index;">
					<ng-container *ngFor="let a of annotations; let i=index;">
						<ng-container *ngIf="t.Id===ab.BaseId && ab.AnnotationId===a.Id">
							<p class="table-annotation"> {{a.Description}} |<button (click)="deleteAnnotationBase(ab.Id)" class="delete-annotation">Remove</button></p>		
						</ng-container>
					</ng-container>
				</ng-container>
		<!--           Display  table fields          -->
				<div *ngFor="let f of t.Fields; let j=index;">
					<div class="table-fields">        
					    <p class="field-id"> {{f.Id}}</p>
					    <p class="field-name"> {{f.Name}}, </p>
					    <p class="field-type"> {{f.Type}}, </p>
                        <ng-container *ngFor="let k of keyRelationships; let n=index;">
                            <ng-container *ngFor="let t2 of tables; let n=index;">
                                    <ng-container *ngFor="let f2 of t2.Fields; let j=index;">
                                            <div class="rel-to" *ngIf="k.ToId==f.Id  && f2.Id==k.FromId && t2.Id==f2.StructuredId">FK from {{t2.Name}}:{{f2.Name}}</div>
                                    </ng-container>
                            </ng-container>
                        <button id="delete-key-relationship" *ngIf="varform == t.Id*(-2) && k.ToId == f.Id" (click)="deleteKeyRelationship(k.Id)"> Delete KR</button>
                        </ng-container>
                        <button id="delete-field" *ngIf="varform === t.Id*(-2)" (click)="deleteField(f.Id)"> Delete field</button>
                        <button id="delete-field-cancel" *ngIf="varform === t.Id*(-2)" (click)="varform=0"> Cancel </button>
					</div>	
				</div>
	<!--           Display table functions          -->
				<p id="add-field" (click)="varform=t.Id"> + Add field </p>
				<p id="add-keys" (click)="varform=t.Id*(-1)"> + Add key relationships </p>
				<p id="delete-field-toggle" (click)="varform=t.Id*(-2)"> x Delete fields / keys</p>
	<!--           Form to assign an annotation to table      -->
				<form [formGroup]="annotationBaseTableForm" (ngSubmit)="addAnnotationBaseTable()"  *ngIf="varform === 5.5">
					<select name="annotations" formControlName="BaseId">
						  	<option [value]="t.Id">{{t.Name}}</option>  
					</select> 
					<select name="annotations" formControlName="AnnotationId">
						<ng-container *ngFor="let a of annotations; let i=index;">
						  	<option [value]="a.Id">{{a.Description}}</option>  
						</ng-container>
					</select> 
					<button [disabled]="annotationBaseTableForm.pristine || annotationBaseTableForm.invalid"> Assign annotation </button>
				</form>
	<!--           Form to add a field          -->
				<form [formGroup]="fieldForm" (ngSubmit)="addPostgresField()"  *ngIf="varform === t.Id">
					<input  type="text" placeholder="Field name" formControlName="Name" >
					
					<select name="types" formControlName="Type">
						  <option value="int">int</option>
						  <option value="nvarchar(max)">nvarchar(max)</option>
						  <option value="JSON">JSON</option>
						  <option value="bool">bool</option>
						  <option value="float8">float8</option>
					</select> 
					<select  formControlName="StructuredId" >
						  <option [value]="t.Id">{{t.Name}}</option>
					</select> 
					<button [disabled]="fieldForm.pristine || fieldForm.invalid"> Add Field </button>
					<button (click)="varform=0" id="cancel"> Cancel </button>
				</form>
	<!--           Form to add a KR          -->
				<form [formGroup]="keyForm" (ngSubmit)="addKeyRelationship()"  *ngIf="varform === t.Id*(-1)">

					<select  formControlName="FromId">
						<ng-container *ngFor="let str of datastore.StructuredFiles; let i=index;">
							<ng-container *ngFor="let unstr of datastore.UnstructuredFiles; let i=index;">
									<option [value]="str.Id">{{str.FilePath}}</option>
									<option [value]="unstr.Id">{{unstr.FilePath}}</option>
							</ng-container>
						</ng-container>
						<ng-container *ngFor="let t3 of tables; let n=index;">
							<ng-container *ngFor="let f3 of t3.Fields; let n=index;">
										<option [value]="f3.Id">{{t3.Name}}:{{f3.Name}}</option>
							</ng-container>
						</ng-container>
					</select> 
					<select  formControlName="ToId">
						<ng-container *ngFor="let str of datastore.StructuredFiles; let i=index;">
							<ng-container *ngFor="let unstr of datastore.UnstructuredFiles; let i=index;">
									<option [value]="str.Id">{{str.FilePath}}</option>
									<option [value]="unstr.Id">{{unstr.FilePath}}</option>
							</ng-container>
						</ng-container>
						<ng-container *ngFor="let t3 of tables; let n=index;">
							<ng-container *ngFor="let f3 of t3.Fields; let n=index;">
										<option [value]="f3.Id">{{t3.Name}}:{{f3.Name}}</option>
							</ng-container>
						</ng-container>
					</select> 
					<select name="types" formControlName="Type">
						  <option value="exact">exact</option>
						  <option value="regex">regex</option>
					</select> 
					<button [disabled]="keyForm.pristine || keyForm.invalid"> Add Relationship </button>
					<button (click)="varform=0" id="cancel"> Cancel </button>
				</form>
			</div>
		</ng-container>
	</div>
    </div>
</div>





